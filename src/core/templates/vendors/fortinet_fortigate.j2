{# Fortinet FortiGate Configuration Template #}
{# Generated by NetConfigPro #}
{# Vendor: Fortinet FortiOS #}
config system global
    set hostname "{{ hostname }}"
{% if domain_name %}
    set hostname-fqdn "{{ hostname }}.{{ domain_name }}"
{% endif %}
end

{% if dns_servers %}
config system dns
{% for dns in dns_servers %}
{% if loop.first %}
    set primary {{ dns }}
{% elif loop.index == 2 %}
    set secondary {{ dns }}
{% endif %}
{% endfor %}
end

{% endif %}
{% if ntp_servers %}
config system ntp
    set ntpsync enable
    set type custom
{% for ntp in ntp_servers %}
    config ntpserver
        edit {{ loop.index }}
            set server "{{ ntp }}"
        next
    end
{% endfor %}
end

{% endif %}
{% if banner_motd %}
config system replacemsg admin "pre_admin-disclaimer-text"
    set buffer "{{ banner_motd | replace('"', '\\"') }}"
end

{% endif %}
{# Interface Configuration #}
{% for iface in interfaces %}
config system interface
    edit "{{ iface.name | fortinet_interface_name }}"
{% if iface.description %}
        set alias "{{ iface.description }}"
{% endif %}
{% if iface.ip_address and iface.subnet_mask %}
        set mode static
        set ip {{ iface.ip_address }} {{ iface.subnet_mask }}
{% endif %}
{% if not iface.enabled %}
        set status down
{% else %}
        set status up
{% endif %}
{% if iface.mtu != 1500 %}
        set mtu-override enable
        set mtu {{ iface.mtu }}
{% endif %}
{% if iface.vlan_id %}
        set vlanid {{ iface.vlan_id }}
        set interface "{{ iface.name | fortinet_parent_interface }}"
        set vdom "root"
{% endif %}
{% if iface.switchport_mode and iface.switchport_mode.value == 'access' and iface.access_vlan %}
        set native-vlan {{ iface.access_vlan }}
{% endif %}
        set allowaccess ping
    next
end

{% endfor %}
{# VLAN Configuration #}
{% for vlan in vlans %}
config system interface
    edit "vlan{{ vlan.vlan_id }}"
        set vdom "root"
        set type vlan
        set vlanid {{ vlan.vlan_id }}
{% if vlan.name %}
        set alias "{{ vlan.name }}"
{% endif %}
        set interface "internal"
    next
end

{% endfor %}
{# Static Routes #}
{% if static_routes %}
config router static
{% for route in static_routes %}
    edit {{ loop.index }}
        set dst {{ route.destination }} {{ route.mask }}
        set gateway {{ route.next_hop }}
{% if route.admin_distance != 1 %}
        set distance {{ route.admin_distance }}
{% endif %}
{% if route.name %}
        set comment "{{ route.name }}"
{% endif %}
    next
{% endfor %}
end

{% endif %}
{# OSPF Configuration #}
{% if ospf %}
config router ospf
    set router-id {{ ospf.router_id if ospf.router_id else '0.0.0.0' }}
{% if ospf.default_information_originate %}
    set default-information-originate enable
{% endif %}
{% if ospf.reference_bandwidth != 100 %}
    set auto-cost-ref-bandwidth {{ ospf.reference_bandwidth }}
{% endif %}
    config area
{% set areas = [] %}
{% for network in ospf.networks %}
{% if network.area not in areas %}
{% set _ = areas.append(network.area) %}
        edit 0.0.0.{{ network.area }}
        next
{% endif %}
{% endfor %}
    end
    config ospf-interface
{% for network in ospf.networks %}
        edit "ospf-net-{{ loop.index }}"
            set interface "{{ network.network | fortinet_ospf_interface }}"
{% if network.network in ospf.passive_interfaces %}
            set passive enable
{% endif %}
        next
{% endfor %}
    end
    config network
{% for network in ospf.networks %}
        edit {{ loop.index }}
            set prefix {{ network.network }} {{ network.wildcard | wildcard_to_netmask }}
            set area 0.0.0.{{ network.area }}
        next
{% endfor %}
    end
end

{% endif %}
{# BGP Configuration #}
{% if bgp %}
config router bgp
    set as {{ bgp.local_as }}
{% if bgp.router_id %}
    set router-id {{ bgp.router_id }}
{% endif %}
{% if bgp.log_neighbor_changes %}
    set log-neighbour-changes enable
{% endif %}
    config neighbor
{% for neighbor in bgp.neighbors %}
        edit "{{ neighbor.ip_address }}"
            set remote-as {{ neighbor.remote_as }}
{% if neighbor.description %}
            set description "{{ neighbor.description }}"
{% endif %}
{% if neighbor.password %}
            set password {{ neighbor.password }}
{% endif %}
{% if neighbor.update_source %}
            set update-source "{{ neighbor.update_source }}"
{% endif %}
{% if neighbor.ebgp_multihop > 0 %}
            set ebgp-multihop-ttl {{ neighbor.ebgp_multihop }}
{% endif %}
{% if neighbor.route_map_in %}
            set route-map-in "{{ neighbor.route_map_in }}"
{% endif %}
{% if neighbor.route_map_out %}
            set route-map-out "{{ neighbor.route_map_out }}"
{% endif %}
        next
{% endfor %}
    end
{% if bgp.networks %}
    config network
{% for network in bgp.networks %}
        edit {{ loop.index }}
            set prefix {{ network }}
        next
{% endfor %}
    end
{% endif %}
{% if bgp.redistribute %}
    config redistribute "connected"
{% if 'connected' in bgp.redistribute %}
        set status enable
{% endif %}
    end
    config redistribute "static"
{% if 'static' in bgp.redistribute %}
        set status enable
{% endif %}
    end
    config redistribute "ospf"
{% if 'ospf' in bgp.redistribute %}
        set status enable
{% endif %}
    end
{% endif %}
end

{% endif %}
{# Prefix Lists (FortiGate uses prefix-list within router) #}
{% if prefix_lists %}
config router prefix-list
{% for prefix_list in prefix_lists %}
    edit "{{ prefix_list.name }}"
        config rule
{% for entry in prefix_list.entries %}
            edit {{ entry.sequence }}
                set action {{ entry.action }}
                set prefix {{ entry.prefix }}
{% if entry.ge %}
                set ge {{ entry.ge }}
{% endif %}
{% if entry.le %}
                set le {{ entry.le }}
{% endif %}
            next
{% endfor %}
        end
    next
{% endfor %}
end

{% endif %}
{# Route Maps #}
{% if route_maps %}
config router route-map
{% for route_map in route_maps %}
    edit "{{ route_map.name }}"
        config rule
{% for entry in route_map.entries %}
            edit {{ entry.sequence }}
                set action {{ entry.action }}
{% if entry.match_prefix_list %}
                set match-ip-address "{{ entry.match_prefix_list }}"
{% endif %}
{% if entry.set_local_pref %}
                set set-local-preference {{ entry.set_local_pref }}
{% endif %}
{% if entry.set_med %}
                set set-metric {{ entry.set_med }}
{% endif %}
{% if entry.set_weight %}
                set set-weight {{ entry.set_weight }}
{% endif %}
{% if entry.set_as_path_prepend %}
                set set-aspath "{{ entry.set_as_path_prepend }}"
{% endif %}
{% if entry.set_community %}
                set set-community "{{ entry.set_community }}"
{% endif %}
            next
{% endfor %}
        end
    next
{% endfor %}
end

{% endif %}
{# ACLs - FortiGate uses firewall policies #}
{% if acls %}
config firewall address
{% for acl in acls %}
{% for entry in acl.entries %}
{% if not entry.remark and entry.source != 'any' %}
    edit "{{ acl.name }}_src_{{ entry.sequence }}"
        set type ipmask
        set subnet {{ entry.source }} {{ entry.source_wildcard | wildcard_to_netmask }}
    next
{% endif %}
{% if not entry.remark and entry.destination != 'any' %}
    edit "{{ acl.name }}_dst_{{ entry.sequence }}"
        set type ipmask
        set subnet {{ entry.destination }} {{ entry.destination_wildcard | wildcard_to_netmask }}
    next
{% endif %}
{% endfor %}
{% endfor %}
end

config firewall policy
{% set policy_id = namespace(value=1) %}
{% for acl in acls %}
{% for entry in acl.entries %}
{% if not entry.remark %}
    edit {{ policy_id.value }}
        set name "{{ acl.name }}_{{ entry.sequence }}"
        set srcintf "any"
        set dstintf "any"
{% if entry.source == 'any' %}
        set srcaddr "all"
{% else %}
        set srcaddr "{{ acl.name }}_src_{{ entry.sequence }}"
{% endif %}
{% if entry.destination == 'any' %}
        set dstaddr "all"
{% else %}
        set dstaddr "{{ acl.name }}_dst_{{ entry.sequence }}"
{% endif %}
        set action {{ 'accept' if entry.action.value == 'permit' else 'deny' }}
        set schedule "always"
{% if entry.protocol.value == 'tcp' %}
        set service "TCP"
{% elif entry.protocol.value == 'udp' %}
        set service "UDP"
{% elif entry.protocol.value == 'icmp' %}
        set service "PING"
{% else %}
        set service "ALL"
{% endif %}
{% if entry.log %}
        set logtraffic all
{% endif %}
        set comments "{{ entry.remark if entry.remark else acl.name }}"
    next
{% set policy_id.value = policy_id.value + 1 %}
{% endif %}
{% endfor %}
{% endfor %}
end

{% endif %}
